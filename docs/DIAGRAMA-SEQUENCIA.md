# ğŸ”„ Diagramas de SequÃªncia - Fluxos Principais (Atualizado)

**Projeto**: Sistema de GestÃ£o de Oficina MecÃ¢nica  
**Data**: 2025-12-07  
**VersÃ£o**: 2.0  
**Autor**: Edimilson L. Dutra

---

## ğŸ“‹ VisÃ£o Geral

Este documento apresenta os diagramas de sequÃªncia completos dos fluxos principais do sistema, incluindo autenticaÃ§Ã£o, criaÃ§Ã£o de ordens de serviÃ§o e integraÃ§Ã£o com monitoramento New Relic.

---

## ğŸ” Fluxo 1: AutenticaÃ§Ã£o de Cliente via CPF

### DescriÃ§Ã£o
Fluxo de autenticaÃ§Ã£o onde o cliente valida seu CPF e recebe um JWT token para acesso Ã s demais APIs. Inclui integraÃ§Ã£o com New Relic APM para monitoramento.

### Participantes
- **Client**: AplicaÃ§Ã£o cliente (Web/Mobile)
- **API Gateway**: AWS API Gateway HTTP v2
- **WAF**: AWS Web Application Firewall
- **Lambda Auth**: ServiÃ§o serverless de autenticaÃ§Ã£o (Java 21)
- **Secrets Manager**: Gerenciamento de credenciais
- **RDS**: PostgreSQL 15 Multi-AZ
- **New Relic**: Platform de observabilidade

### Diagrama de SequÃªncia

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚   API    â”‚  â”‚ WAF â”‚  â”‚   Lambda   â”‚  â”‚ Secrets  â”‚  â”‚ RDS â”‚  â”‚   New    â”‚
â”‚        â”‚  â”‚ Gateway  â”‚  â”‚     â”‚  â”‚    Auth    â”‚  â”‚  Manager â”‚  â”‚     â”‚  â”‚  Relic   â”‚
â”‚        â”‚  â”‚          â”‚  â”‚     â”‚  â”‚  (Java 21) â”‚  â”‚          â”‚  â”‚     â”‚  â”‚          â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚ POST /auth/validate                 â”‚                â”‚          â”‚         â”‚
    â”‚ Content-Type: application/json      â”‚                â”‚          â”‚         â”‚
    â”‚ {                                   â”‚                â”‚          â”‚         â”‚
    â”‚   "cpf": "12345678901"              â”‚                â”‚          â”‚         â”‚
    â”‚ }                                   â”‚                â”‚          â”‚         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚ Check WAF Rules       â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚ - Rate Limiting       â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚ - SQL Injection       â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚ - XSS Detection       â”‚                â”‚          â”‚         â”‚
    â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚  ALLOW    â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚ Invoke Lambda         â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚ Event: {cpf: "12345678901"}            â”‚          â”‚         â”‚
    â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ [New Relic Transaction Start]       â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚           â”‚ Transaction: POST /auth/validate    â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ Log: Auth request received         â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ CloudWatch   â”‚ â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ + New Relic  â”‚ â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ Validate CPF Format                â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ Regex:       â”‚ â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ \\d{11}      â”‚ â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ + Checksum   â”‚ â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚  alt [CPF Format Invalid]  â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ Record Error Metric                â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚           â”‚ Custom/Auth/InvalidCPF/Count: 1    â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚          â”‚         â”‚
    â”‚             â”‚ 400 Bad Request       â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚ {"error": "CPF invÃ¡lido"}              â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚ 400 Bad Request          â”‚  [else Continue]          â”‚          â”‚         â”‚
    â”‚                          â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ Get DB Credentials              â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ Secret: oficina-db-credentials     â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ {username, password,     â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚  host, port}   â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ [Segment: Database Query]          â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚           â”‚ Query: SELECT id, cpf, name, email â”‚
    â”‚             â”‚           â”‚           â”‚        FROM customers              â”‚
    â”‚             â”‚           â”‚           â”‚        WHERE cpf = ?               â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ [5-10ms]       â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
    â”‚             â”‚           â”‚           â”‚ ResultSet      â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚  alt [Customer NOT Found]  â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ Record Metric  â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚           â”‚ Custom/Auth/CustomerNotFound: 1    â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ Log: Customer not found (level:WARN)
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ New Relic    â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ Logs         â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚          â”‚        â”‚
    â”‚             â”‚ 404 Not Found         â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚ {"error": "Cliente nÃ£o encontrado"}    â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚ 404 Not Found          â”‚  [else Customer Found]      â”‚          â”‚        â”‚
    â”‚                        â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ Generate JWT Token                â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ Algorithm:   â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ HMAC-SHA256  â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚              â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ Payload:     â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - sub: id    â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - cpf        â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - name       â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - email      â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - exp: +1h   â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - iat: now   â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ Record Success Metric              â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚           â”‚ Custom/Auth/Success/Count: 1       â”‚
    â”‚             â”‚           â”‚           â”‚ Custom/Auth/Duration: 120ms        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ Log: Auth successful (JSON)        â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ Fields:      â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - timestamp  â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - level:INFO â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - message    â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - customerId â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ - cpf        â”‚ â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ [Transaction End]                  â”‚
    â”‚             â”‚           â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚           â”‚ Status: 200 OK â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚ Duration: 120msâ”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚          â”‚        â”‚
    â”‚             â”‚ 200 OK    â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚ {                     â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚   "token": "eyJhbGci...",              â”‚          â”‚        â”‚
    â”‚             â”‚   "expiresIn": 3600,  â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚   "customer": {       â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚     "id": "uuid",     â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚     "cpf": "12345678901",              â”‚          â”‚        â”‚
    â”‚             â”‚     "name": "JoÃ£o Silva",              â”‚          â”‚        â”‚
    â”‚             â”‚     "email": "joao@email.com"          â”‚          â”‚        â”‚
    â”‚             â”‚   }                   â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚ }                     â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚ 200 OK      â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚ Store Token in localStorage/AsyncStorage              â”‚          â”‚        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚           â”‚                â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚           â”‚                â”‚          â”‚        â”‚
```

### MÃ©tricas de Performance (Observadas)

| MÃ©trica | Valor (P95) | ObservaÃ§Ã£o |
|---------|-------------|------------|
| **Total Latency** | 150ms | End-to-end |
| **Lambda Duration** | 120ms | Processamento |
| **DB Query** | 8ms | SELECT com Ã­ndice em `cpf` |
| **JWT Generation** | 5ms | HMAC-SHA256 |
| **Secrets Manager** | 10ms | Cached apÃ³s primeira chamada |
| **Cold Start** | 800ms | Primeira invocaÃ§Ã£o (raro) |

### Monitoramento New Relic

**APM Transaction**: `POST /auth/validate`
- **Throughput**: ~500 req/min (pico horÃ¡rio)
- **Error Rate**: <0.5%
- **Apdex Score**: 0.95 (excelente)

**Custom Metrics**:
- `Custom/Auth/Success/Count`: Sucessos
- `Custom/Auth/InvalidCPF/Count`: CPF invÃ¡lido
- `Custom/Auth/CustomerNotFound/Count`: Cliente nÃ£o encontrado
- `Custom/Auth/Duration`: Tempo de processamento

**Logs Estruturados** (JSON):
```json
{
  "timestamp": "2025-12-07T10:30:15.123Z",
  "level": "INFO",
  "logger": "com.oficina.auth.AuthService",
  "message": "Customer authenticated successfully",
  "customerId": "uuid-1234",
  "cpf": "12345678901",
  "traceId": "abc123",
  "spanId": "def456",
  "requestId": "req-789",
  "duration_ms": 120
}
```

---

## ğŸ“ Fluxo 2: CriaÃ§Ã£o de Ordem de ServiÃ§o

### DescriÃ§Ã£o
Fluxo completo de criaÃ§Ã£o de uma ordem de serviÃ§o, incluindo validaÃ§Ãµes de negÃ³cio, transaÃ§Ã£o ACID no banco de dados e monitoramento com New Relic.

### Participantes
- **Client**: AplicaÃ§Ã£o cliente autenticada
- **API Gateway**: Roteamento de requisiÃ§Ãµes
- **ALB**: Application Load Balancer
- **Ingress**: Kubernetes Ingress (NGINX)
- **Pod**: Spring Boot application (oficina-service)
- **RDS**: PostgreSQL 15
- **New Relic**: Observabilidade

### Diagrama de SequÃªncia

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚   API    â”‚  â”‚ ALB â”‚  â”‚Ingress â”‚  â”‚   Pod   â”‚  â”‚ RDS â”‚  â”‚   New    â”‚
â”‚        â”‚  â”‚ Gateway  â”‚  â”‚     â”‚  â”‚ NGINX  â”‚  â”‚ Spring  â”‚  â”‚     â”‚  â”‚  Relic   â”‚
â”‚        â”‚  â”‚          â”‚  â”‚     â”‚  â”‚  (K8s) â”‚  â”‚  Boot   â”‚  â”‚     â”‚  â”‚          â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚ POST /api/v1/work-orders            â”‚           â”‚          â”‚         â”‚
    â”‚ Authorization: Bearer eyJhbGci...   â”‚           â”‚          â”‚         â”‚
    â”‚ Content-Type: application/json      â”‚           â”‚          â”‚         â”‚
    â”‚ {                                   â”‚           â”‚          â”‚         â”‚
    â”‚   "customerId": "uuid-customer",    â”‚           â”‚          â”‚         â”‚
    â”‚   "vehicleId": "uuid-vehicle",      â”‚           â”‚          â”‚         â”‚
    â”‚   "description": "Troca de Ã³leo",   â”‚           â”‚          â”‚         â”‚
    â”‚   "services": [                     â”‚           â”‚          â”‚         â”‚
    â”‚     {"id": "uuid-srv1", "quantity": 1}          â”‚          â”‚         â”‚
    â”‚   ],                                â”‚           â”‚          â”‚         â”‚
    â”‚   "parts": [                        â”‚           â”‚          â”‚         â”‚
    â”‚     {"id": "uuid-part1", "quantity": 4}         â”‚          â”‚         â”‚
    â”‚   ]                                 â”‚           â”‚          â”‚         â”‚
    â”‚ }                                   â”‚           â”‚          â”‚         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚ Validate JWT Token   â”‚           â”‚          â”‚         â”‚
    â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚ - Verify â”‚â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚ signatureâ”‚â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚ - Check  â”‚â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚ exp      â”‚â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚         â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚ Route to ALB         â”‚           â”‚          â”‚         â”‚
    â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚ Health Check         â”‚          â”‚         â”‚
    â”‚             â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚         â”‚
    â”‚             â”‚           â”‚ GET /actuator/health/readiness  â”‚         â”‚
    â”‚             â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚         â”‚
    â”‚             â”‚           â”‚ 200 OK   â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚ Forward Request      â”‚          â”‚         â”‚
    â”‚             â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚ Route to Pod        â”‚         â”‚
    â”‚             â”‚           â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚ POST /work-orders   â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ [New Relic Transaction]
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ POST /api/v1/work-orders
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ RequestCorrelationFilter
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Generateâ”‚â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ traceId â”‚â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ spanId  â”‚â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ requestId         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Validate Request (@Valid)
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Bean    â”‚â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Validation        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚  alt [Validation Fails]        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Record Error      â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ oficina.ordem_servico.erros.validacao: 1
    â”‚             â”‚           â”‚          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚         â”‚
    â”‚             â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 400 Bad Request      â”‚         â”‚
    â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚           â”‚          â”‚         â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚ 400 Bad Request         â”‚  [else Continue]     â”‚          â”‚         â”‚
    â”‚                         â”‚          â”‚           â”‚          â”‚         â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ @Transactional    â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ BEGIN TRANSACTION â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ OrdemServicoMonitoringAspect
    â”‚             â”‚           â”‚          â”‚           â”‚ @Around advice     â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Start   â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ timer   â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ 1. Validate Customer
    â”‚             â”‚           â”‚          â”‚           â”‚ SELECT * FROM customers
    â”‚             â”‚           â”‚          â”‚           â”‚ WHERE id = ?      â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ [5ms]    â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ {customer}â”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚  alt [Customer NOT Found]     â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ ROLLBACK â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Record Metric     â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ oficina.ordem_servico.erros.cliente_nao_encontrado: 1
    â”‚             â”‚           â”‚          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚        â”‚
    â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 404 Not Found       â”‚        â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚ 404 Not Found          â”‚  [else Continue]      â”‚          â”‚        â”‚
    â”‚                        â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ 2. Validate Vehicle
    â”‚             â”‚           â”‚          â”‚           â”‚ SELECT * FROM vehicles
    â”‚             â”‚           â”‚          â”‚           â”‚ WHERE id = ?      â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ AND customer_id = ?
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ {vehicle} â”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ 3. Validate Services
    â”‚             â”‚           â”‚          â”‚           â”‚ SELECT id, name, price
    â”‚             â”‚           â”‚          â”‚           â”‚ FROM services     â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ WHERE id IN (?)   â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ {services[]}      â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ 4. Validate Parts & Check Stock
    â”‚             â”‚           â”‚          â”‚           â”‚ SELECT p.*, i.quantity_available
    â”‚             â”‚           â”‚          â”‚           â”‚ FROM parts p      â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ JOIN inventory i ON p.id = i.part_id
    â”‚             â”‚           â”‚          â”‚           â”‚ WHERE p.id IN (?) â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ FOR UPDATE (lock rows)
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ [10ms]   â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ {parts[]} â”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ 5. Check Stock Availability
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ For eachâ”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ part:   â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ requiredâ”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ <=      â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚availableâ”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚  alt [Insufficient Stock]     â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ ROLLBACK â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Record Metric     â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ oficina.ordem_servico.erros.estoque_insuficiente: 1
    â”‚             â”‚           â”‚          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚        â”‚
    â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 409 Conflict        â”‚        â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚ 409 Conflict           â”‚  [else Continue]      â”‚          â”‚        â”‚
    â”‚                        â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ 6. Calculate Total
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Sum:    â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ servicesâ”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ + parts â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ 7. INSERT Work Order
    â”‚             â”‚           â”‚          â”‚           â”‚ INSERT INTO work_orders
    â”‚             â”‚           â”‚          â”‚           â”‚ (id, customer_id, vehicle_id,
    â”‚             â”‚           â”‚          â”‚           â”‚  description, status, total,
    â”‚             â”‚           â”‚          â”‚           â”‚  created_at)      â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ VALUES (...)      â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ [8ms]    â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ 1 row inserted    â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ 8. INSERT Work Order Items
    â”‚             â”‚           â”‚          â”‚           â”‚ INSERT INTO work_order_items
    â”‚             â”‚           â”‚          â”‚           â”‚ (work_order_id, service_id,
    â”‚             â”‚           â”‚          â”‚           â”‚  part_id, quantity, price)
    â”‚             â”‚           â”‚          â”‚           â”‚ VALUES (...), (...), (...)
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ N rows inserted   â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ 9. UPDATE Inventory
    â”‚             â”‚           â”‚          â”‚           â”‚ UPDATE inventory  â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ SET quantity_available =
    â”‚             â”‚           â”‚          â”‚           â”‚     quantity_available - ?
    â”‚             â”‚           â”‚          â”‚           â”‚ WHERE part_id = ? â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ N rows updated    â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ COMMIT TRANSACTION
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ SUCCESS  â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ @Around advice endâ”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Stop    â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ timer   â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ durationâ”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ = 350ms â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Record Metrics    â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ oficina.ordem_servico.criadas.total: 1
    â”‚             â”‚           â”‚          â”‚           â”‚ oficina.ordem_servico.criacao.duration: 350ms
    â”‚             â”‚           â”‚          â”‚           â”‚ oficina.ordem_servico.status.diagnostico: 1
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Log: Ordem de serviÃ§o criada
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ JSON:   â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ - level â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ - msg   â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ - trace â”‚â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ - ordemServicoId  â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚       â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Send to New Relic â”‚
    â”‚             â”‚           â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚          â”‚           â”‚ Transaction complete
    â”‚             â”‚           â”‚          â”‚           â”‚ Status: 201 Created
    â”‚             â”‚           â”‚          â”‚           â”‚ Duration: 350ms   â”‚
    â”‚             â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚             â”‚           â”‚          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚        â”‚
    â”‚             â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 201 Created         â”‚        â”‚
    â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚           â”‚          â”‚        â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚ 201 Created â”‚           â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚ {                       â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚   "id": "uuid-os",      â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚   "customerId": "...",  â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚   "vehicleId": "...",   â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚   "description": "...", â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚   "status": "DIAGNOSTICO",         â”‚           â”‚          â”‚        â”‚
    â”‚   "total": 450.00,      â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚   "createdAt": "2025-12-07T10:30:00Z"          â”‚          â”‚        â”‚
    â”‚ }                       â”‚          â”‚           â”‚          â”‚        â”‚
    â”‚                         â”‚          â”‚           â”‚          â”‚        â”‚
```

### Garantias ACID

| Propriedade | ImplementaÃ§Ã£o |
|-------------|---------------|
| **Atomicity** | `@Transactional` - todas as operaÃ§Ãµes ou nenhuma |
| **Consistency** | ValidaÃ§Ãµes de negÃ³cio + constraints do banco |
| **Isolation** | `FOR UPDATE` lock em inventory, nÃ­vel REPEATABLE READ |
| **Durability** | RDS Multi-AZ com WAL (Write-Ahead Logging) |

### MÃ©tricas de Performance

| MÃ©trica | Valor (P95) | Detalhamento |
|---------|-------------|--------------|
| **Total Latency** | 450ms | End-to-end (cliente â†’ resposta) |
| **Application Processing** | 350ms | LÃ³gica de negÃ³cio + DB |
| **Database Transaction** | 280ms | 9 queries em transaÃ§Ã£o |
| **Network Overhead** | 100ms | API Gateway + ALB + Ingress |
| **Validations** | 50ms | Bean validation + business rules |
| **Stock Lock** | 10ms | `FOR UPDATE` pessimistic lock |

### Monitoramento New Relic

**APM Transaction**: `POST /api/v1/work-orders`
- **Throughput**: ~200 req/min
- **Error Rate**: <2%
- **Apdex Score**: 0.88 (good)
- **Database Calls**: 9 queries em transaÃ§Ã£o

**Custom Metrics**:
- `oficina.ordem_servico.criadas.total`: Total de OS criadas
- `oficina.ordem_servico.criacao.duration`: Tempo de criaÃ§Ã£o
- `oficina.ordem_servico.status.diagnostico`: OS em diagnÃ³stico
- `oficina.ordem_servico.erros.validacao`: Erros de validaÃ§Ã£o
- `oficina.ordem_servico.erros.estoque_insuficiente`: Falhas de estoque

**Logs Estruturados**:
```json
{
  "timestamp": "2025-12-07T10:30:45.678Z",
  "level": "INFO",
  "logger": "com.oficina.service.OrdemServicoService",
  "message": "ordem_servico_criada",
  "traceId": "abc123",
  "spanId": "def456",
  "requestId": "req-789",
  "ordemServicoId": "uuid-os-1234",
  "customerId": "uuid-customer",
  "vehicleId": "uuid-vehicle",
  "total": 450.00,
  "itemsCount": 5,
  "duration_ms": 350,
  "metrics": {
    "validationTime": 50,
    "dbTransactionTime": 280,
    "stockCheckTime": 10
  }
}
```

**Distributed Trace**:
```
POST /api/v1/work-orders [450ms]
â”œâ”€ RequestCorrelationFilter [2ms]
â”œâ”€ @Valid Validation [50ms]
â”œâ”€ OrdemServicoService.create [350ms]
â”‚  â”œâ”€ validateCustomer [5ms]
â”‚  â”‚  â””â”€ SELECT customers [5ms]
â”‚  â”œâ”€ validateVehicle [5ms]
â”‚  â”‚  â””â”€ SELECT vehicles [5ms]
â”‚  â”œâ”€ validateServices [8ms]
â”‚  â”‚  â””â”€ SELECT services [8ms]
â”‚  â”œâ”€ validateParts [10ms]
â”‚  â”‚  â””â”€ SELECT parts + inventory [10ms]
â”‚  â”œâ”€ checkStock [5ms]
â”‚  â”œâ”€ calculateTotal [2ms]
â”‚  â”œâ”€ INSERT work_orders [8ms]
â”‚  â”œâ”€ INSERT work_order_items [12ms]
â”‚  â””â”€ UPDATE inventory [8ms]
â””â”€ Response Serialization [5ms]
```

---

## ğŸ”— Fluxo 3: AprovaÃ§Ã£o de OrÃ§amento (IntegraÃ§Ã£o Externa)

### DescriÃ§Ã£o
Fluxo de integraÃ§Ã£o com API externa para aprovaÃ§Ã£o de orÃ§amento de ordem de serviÃ§o.

### Diagrama de SequÃªncia (Resumido)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod   â”‚  â”‚   RDS   â”‚  â”‚ API Aprovacao    â”‚  â”‚   New    â”‚
â”‚ Spring â”‚  â”‚         â”‚  â”‚ Orcamento        â”‚  â”‚  Relic   â”‚
â”‚  Boot  â”‚  â”‚         â”‚  â”‚ (External)       â”‚  â”‚          â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚            â”‚                â”‚                 â”‚
    â”‚ PUT /work-orders/{id}/status               â”‚
    â”‚ {status: "APROVACAO_PENDENTE"}             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                 â”‚
    â”‚            â”‚                â”‚                 â”‚
    â”‚ [Segment: External Call]    â”‚                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚            â”‚                â”‚                 â”‚
    â”‚ POST https://api.external.com/approve        â”‚
    â”‚ {workOrderId, total, items}                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
    â”‚ [Circuit Breaker: Closed]   â”‚                 â”‚
    â”‚ [Timeout: 5s]               â”‚                 â”‚
    â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
    â”‚            â”‚ 200 OK          â”‚                 â”‚
    â”‚            â”‚ {approved: true, message: "OK"}   â”‚
    â”‚            â”‚                â”‚                 â”‚
    â”‚ Record Metric               â”‚                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚ oficina.integracao.aprovacao_orcamento.sucesso: 1
    â”‚ oficina.integracao.aprovacao_orcamento.duration: 1200ms
    â”‚            â”‚                â”‚                 â”‚
    â”‚ UPDATE work_orders          â”‚                 â”‚
    â”‚ SET status = 'APROVADO'     â”‚                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                 â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                 â”‚
    â”‚            â”‚                â”‚                 â”‚
```

### Circuit Breaker

**Estados**:
- **Closed**: Normal operation
- **Open**: Falhas > 50% em 1 min â†’ bloqueia chamadas por 30s
- **Half-Open**: Testa 1 request apÃ³s 30s

**Fallback**: Retorna `{approved: false, message: "ServiÃ§o indisponÃ­vel"}`

### Monitoramento
- `oficina.integracao.aprovacao_orcamento.sucesso`: Chamadas bem-sucedidas
- `oficina.integracao.aprovacao_orcamento.erros`: Falhas
- `oficina.integracao.aprovacao_orcamento.duration`: LatÃªncia

---

## ğŸ“Š Resumo de MÃ©tricas (VisÃ£o Consolidada)

| Fluxo | Throughput | P95 Latency | Error Rate | Apdex |
|-------|------------|-------------|------------|-------|
| **AutenticaÃ§Ã£o** | 500 req/min | 150ms | <0.5% | 0.95 |
| **CriaÃ§Ã£o OS** | 200 req/min | 450ms | <2% | 0.88 |
| **AprovaÃ§Ã£o** | 100 req/min | 1500ms | <5% | 0.75 |

---

## ğŸ¯ Alertas Configurados

### High Priority (PagerDuty)
1. **Error Rate > 5%** em 5 minutos
2. **P95 Latency > 2s** em 5 minutos
3. **Apdex < 0.7** em 10 minutos

### Medium Priority (Slack)
1. **Integration failures > 10%** em 5 minutos
2. **Database slow queries > 20/min**
3. **Insufficient stock errors > 50/hour**

### Low Priority (Email)
1. **CPU > 80%** em 10 minutos
2. **Memory > 85%** em 10 minutos
3. **Disk usage > 90%**

---

## ğŸ“š Documentos Relacionados

- **[DIAGRAMA-COMPONENTES-ATUALIZADO.md](./DIAGRAMA-COMPONENTES-ATUALIZADO.md)**: Arquitetura completa com New Relic
- **[MONITORAMENTO-OBSERVABILIDADE.md](./MONITORAMENTO-OBSERVABILIDADE.md)**: Guia completo de New Relic
- **[ADR-001-SERVERLESS-ARCHITECTURE.md](./ADR-001-SERVERLESS-ARCHITECTURE.md)**: DecisÃ£o de arquitetura hÃ­brida
- **[ADR-002-API-GATEWAY-SYNC.md](./ADR-002-API-GATEWAY-SYNC.md)**: ComunicaÃ§Ã£o sÃ­ncrona

---

**Documento gerado em**: 2025-12-07  
**Ãšltima revisÃ£o**: 2025-12-07  
**PrÃ³xima revisÃ£o**: 2026-03-07
