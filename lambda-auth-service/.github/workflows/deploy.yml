name: Deploy Lambda Auth Service

on:
  push:
    branches:
      - develop    # Auto-deploy to DEV
      - staging    # Auto-deploy to STAGING  
      - main       # Deploy to PROD (requires approval)
  pull_request:
    branches:
      - develop
      - staging
      - main

env:
  AWS_REGION: us-east-1
  JAVA_VERSION: '21'

jobs:
  # ============================================
  # Job 1: Build and Test
  # ============================================
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'corretto'
          cache: 'maven'
      
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Run tests
        run: mvn clean test
      
      - name: Generate test coverage report
        run: mvn jacoco:report
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./target/site/jacoco/jacoco.xml
          fail_ci_if_error: false
      
      - name: Build JAR
        run: mvn package -DskipTests
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: lambda-jar
          path: target/*.jar
          retention-days: 7

  # ============================================
  # Job 2: Security Scan
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'lambda-auth-service'
          path: '.'
          format: 'HTML'
      
      - name: Upload OWASP report
        uses: actions/upload-artifact@v3
        with:
          name: owasp-report
          path: reports/
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # Job 3: Validate SAM Template
  # ============================================
  validate-sam-template:
    name: Validate SAM Template
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
      
      - name: Validate SAM template
        run: sam validate --lint
      
      - name: Check SAM template for cfn-lint
        uses: scottbrenner/cfn-lint-action@v2
        with:
          args: template.yaml

  # ============================================
  # Job 4: Deploy to DEV
  # ============================================
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: [build, security-scan, validate-sam-template]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: development
      url: https://api-dev.oficina.com/auth
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'corretto'
      
      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: lambda-jar
          path: target/
      
      - name: Build SAM application
        run: sam build
      
      - name: Deploy to DEV
        run: |
          sam deploy \
            --config-env dev \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Environment=dev \
              VpcId=${{ secrets.VPC_ID_DEV }} \
              SubnetIds=${{ secrets.SUBNET_IDS_DEV }} \
              SecurityGroupIds=${{ secrets.SG_IDS_DEV }} \
              DBSecretArn=${{ secrets.DB_SECRET_ARN_DEV }}
      
      - name: Run smoke tests
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name lambda-auth-service-dev \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          
          echo "Testing endpoint: $API_URL/auth"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST $API_URL/auth \
            -H "Content-Type: application/json" \
            -d '{"cpf": "12345678901"}')
          
          if [ "$RESPONSE" -ne 200 ] && [ "$RESPONSE" -ne 404 ]; then
            echo "Smoke test failed with status: $RESPONSE"
            exit 1
          fi
          
          echo "âœ… Smoke test passed!"
      
      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: 'Lambda Auth Service deployed to DEV'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # ============================================
  # Job 5: Deploy to STAGING
  # ============================================
  deploy-staging:
    name: Deploy to STAGING
    runs-on: ubuntu-latest
    needs: [build, security-scan, validate-sam-template]
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    environment:
      name: staging
      url: https://api-staging.oficina.com/auth
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'corretto'
      
      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: lambda-jar
          path: target/
      
      - name: Build SAM application
        run: sam build
      
      - name: Deploy to STAGING
        run: |
          sam deploy \
            --config-env staging \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Environment=staging \
              VpcId=${{ secrets.VPC_ID_STAGING }} \
              SubnetIds=${{ secrets.SUBNET_IDS_STAGING }} \
              SecurityGroupIds=${{ secrets.SG_IDS_STAGING }} \
              DBSecretArn=${{ secrets.DB_SECRET_ARN_STAGING }}
      
      - name: Run smoke tests
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name lambda-auth-service-staging \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          
          echo "Testing endpoint: $API_URL/auth"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST $API_URL/auth \
            -H "Content-Type: application/json" \
            -d '{"cpf": "12345678901"}')
          
          if [ "$RESPONSE" -ne 200 ] && [ "$RESPONSE" -ne 404 ]; then
            echo "Smoke test failed with status: $RESPONSE"
            exit 1
          fi
          
          echo "âœ… Smoke test passed!"
      
      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: 'Lambda Auth Service deployed to STAGING'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # ============================================
  # Job 6: Deploy to PRODUCTION (Manual Approval)
  # ============================================
  deploy-prod:
    name: Deploy to PRODUCTION
    runs-on: ubuntu-latest
    needs: [build, security-scan, validate-sam-template]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://api.oficina.com/auth
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'corretto'
      
      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: lambda-jar
          path: target/
      
      - name: Build SAM application
        run: sam build
      
      - name: Create deployment changeset
        run: |
          sam deploy \
            --config-env prod \
            --no-execute-changeset \
            --parameter-overrides \
              Environment=prod \
              VpcId=${{ secrets.VPC_ID_PROD }} \
              SubnetIds=${{ secrets.SUBNET_IDS_PROD }} \
              SecurityGroupIds=${{ secrets.SG_IDS_PROD }} \
              DBSecretArn=${{ secrets.DB_SECRET_ARN_PROD }}
      
      - name: Deploy to PRODUCTION
        id: deploy-prod
        run: |
          # Publish new version
          FUNCTION_NAME="lambda-auth-service-prod"
          
          # Get current version
          CURRENT_VERSION=$(aws lambda list-versions-by-function \
            --function-name $FUNCTION_NAME \
            --query 'Versions[-1].Version' \
            --output text)
          
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Deploy with SAM
          sam deploy \
            --config-env prod \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Environment=prod \
              VpcId=${{ secrets.VPC_ID_PROD }} \
              SubnetIds=${{ secrets.SUBNET_IDS_PROD }} \
              SecurityGroupIds=${{ secrets.SG_IDS_PROD }} \
              DBSecretArn=${{ secrets.DB_SECRET_ARN_PROD }}
          
          # Publish new version after deployment
          NEW_VERSION=$(aws lambda publish-version \
            --function-name $FUNCTION_NAME \
            --description "Deployed from GitHub Actions - SHA: ${{ github.sha }}" \
            --query 'Version' \
            --output text)
          
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Update alias to point to new version
          aws lambda update-alias \
            --function-name $FUNCTION_NAME \
            --name production \
            --function-version $NEW_VERSION \
            --routing-config AdditionalVersionWeights={"$CURRENT_VERSION"=0.1} || \
          aws lambda create-alias \
            --function-name $FUNCTION_NAME \
            --name production \
            --function-version $NEW_VERSION \
            --routing-config AdditionalVersionWeights={"$CURRENT_VERSION"=0.1}
          
          echo "Deployed with gradual rollout: 90% new version, 10% old version"
      
      - name: Run smoke tests
        id: smoke-test
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name lambda-auth-service-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          
          echo "Testing endpoint: $API_URL/auth"
          
          # Test multiple times
          SUCCESS_COUNT=0
          for i in {1..10}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST $API_URL/auth \
              -H "Content-Type: application/json" \
              -d '{"cpf": "12345678901"}')
            
            if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 404 ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
            sleep 2
          done
          
          if [ $SUCCESS_COUNT -lt 8 ]; then
            echo "âŒ Smoke test failed: Only $SUCCESS_COUNT/10 requests succeeded"
            echo "smoke_test_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… Smoke test passed: $SUCCESS_COUNT/10 requests succeeded"
          echo "smoke_test_passed=true" >> $GITHUB_OUTPUT

      - name: Monitor CloudWatch Metrics
        run: |
          FUNCTION_NAME="lambda-auth-service-prod"
          
          # Check error rate
          ERROR_COUNT=$(aws cloudwatch get-metric-statistics \
            --namespace AWS/Lambda \
            --metric-name Errors \
            --dimensions Name=FunctionName,Value=$FUNCTION_NAME \
            --start-time $(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%S) \
            --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
            --period 300 \
            --statistics Sum \
            --region ${{ env.AWS_REGION }} \
            --query 'Datapoints[0].Sum' \
            --output text)
          
          echo "Error count in last 5 minutes: ${ERROR_COUNT:-0}"
          
          # Check duration
          AVG_DURATION=$(aws cloudwatch get-metric-statistics \
            --namespace AWS/Lambda \
            --metric-name Duration \
            --dimensions Name=FunctionName,Value=$FUNCTION_NAME \
            --start-time $(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%S) \
            --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
            --period 300 \
            --statistics Average \
            --region ${{ env.AWS_REGION }} \
            --query 'Datapoints[0].Average' \
            --output text)
          
          echo "Average duration in last 5 minutes: ${AVG_DURATION:-0}ms"

      - name: Complete Rollout
        if: success()
        run: |
          FUNCTION_NAME="lambda-auth-service-prod"
          NEW_VERSION="${{ steps.deploy-prod.outputs.new_version }}"
          
          echo "Smoke tests passed. Completing rollout to 100% new version..."
          
          # Update alias to 100% new version
          aws lambda update-alias \
            --function-name $FUNCTION_NAME \
            --name production \
            --function-version $NEW_VERSION
          
          echo "âœ… Rollout complete: 100% traffic on version $NEW_VERSION"
      
      - name: Run load tests
        run: |
          # Install artillery
          npm install -g artillery
          
          # Create load test config
          cat > load-test.yml <<EOF
          config:
            target: "$(aws cloudformation describe-stacks \
              --stack-name lambda-auth-service-prod \
              --query 'Stacks[0].Outputs[?OutputKey==\`ApiUrl\`].OutputValue' \
              --output text)"
            phases:
              - duration: 60
                arrivalRate: 5
          scenarios:
            - name: "Auth"
              flow:
                - post:
                    url: "/auth"
                    json:
                      cpf: "12345678901"
          EOF
          
          # Run load test
          artillery run load-test.yml
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release ${{ github.run_number }}
          body: |
            ## Changes in this Release
            - Deployed to production
            - Build: ${{ github.sha }}
            
            ## Deployment Info
            - Stack: lambda-auth-service-prod
            - Region: ${{ env.AWS_REGION }}
            - Timestamp: ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false
      
      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: 'ğŸš€ Lambda Auth Service deployed to PRODUCTION'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      
      - name: Notify PagerDuty
        if: failure()
        uses: Entle/action-pagerduty-alert@0.2.0
        with:
          pagerduty-integration-key: ${{ secrets.PAGERDUTY_INTEGRATION_KEY }}
          pagerduty-dedup-key: lambda-auth-prod-deployment-${{ github.run_id }}
          pagerduty-event-action: trigger
          pagerduty-summary: 'Production deployment failed for lambda-auth-service'

  # ============================================
  # Job 7: Rollback Lambda on Failure
  # ============================================
  rollback-prod:
    name: Rollback Production Lambda
    runs-on: ubuntu-latest
    needs: [deploy-prod]
    if: failure()
    environment:
      name: production
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Rollback to Previous Version
        run: |
          FUNCTION_NAME="lambda-auth-service-prod"
          
          # Get previous version from alias
          PREVIOUS_VERSION=$(aws lambda get-alias \
            --function-name $FUNCTION_NAME \
            --name production \
            --query 'RoutingConfig.AdditionalVersionWeights' \
            --output text | cut -f1)
          
          if [ -z "$PREVIOUS_VERSION" ]; then
            echo "No previous version found in routing config. Getting second-to-last version..."
            PREVIOUS_VERSION=$(aws lambda list-versions-by-function \
              --function-name $FUNCTION_NAME \
              --query 'Versions[-2].Version' \
              --output text)
          fi
          
          echo "Rolling back to version: $PREVIOUS_VERSION"
          
          # Update alias to point to previous version
          aws lambda update-alias \
            --function-name $FUNCTION_NAME \
            --name production \
            --function-version $PREVIOUS_VERSION
          
          echo "âœ… Rollback complete: Alias 'production' now points to version $PREVIOUS_VERSION"
      
      - name: Verify Rollback
        run: |
          FUNCTION_NAME="lambda-auth-service-prod"
          
          # Verify alias configuration
          CURRENT_VERSION=$(aws lambda get-alias \
            --function-name $FUNCTION_NAME \
            --name production \
            --query 'FunctionVersion' \
            --output text)
          
          echo "Current production version after rollback: $CURRENT_VERSION"
          
          # Test the rolled-back version
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name lambda-auth-service-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST $API_URL/auth \
            -H "Content-Type: application/json" \
            -d '{"cpf": "12345678901"}')
          
          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 404 ]; then
            echo "âœ… Rollback verification passed"
          else
            echo "âš ï¸ Rollback verification returned: $RESPONSE"
          fi
      
      - name: Notify Slack - Rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: 'ğŸ”„ Lambda Auth Service - ROLLBACK EXECUTED',
              attachments: [{
                color: 'warning',
                text: `Environment: Production\nReason: Deployment failed\nAction: Rolled back to previous version\nCommit: ${{ github.sha }}`
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
